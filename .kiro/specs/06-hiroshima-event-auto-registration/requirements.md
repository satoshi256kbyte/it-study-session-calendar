# 要件定義書

## 概要

この機能は、既存のバッチ処理システムを拡張して、connpassから広島のIT勉強会を自動的に発見・登録する機能を追加します。システムは「広島」キーワードでイベントを検索し、重複をチェックして、手動登録と同じデータ構造と通知フローで新しいイベントを自動登録します。

## 要件

### 要件1

**ユーザーストーリー:**
システム管理者として、バッチ処理システムがconnpassから広島のITイベントを自動的に発見できるようにしたい。これにより、手動介入なしに地域のイベントを取得できる。

#### 受け入れ基準

1. バッチ処理が実行される時、システムは「広島」キーワードでconnpass APIを1回検索する
2. connpass APIがイベントを返す時、システムはタイトル、URL、開催日時を含むイベント詳細を抽出する
3. API検索を実行する時、システムはconnpass API要件に従ってAPIレート制限を余裕を持って守る（5秒間隔）
4. APIエラーが発生した時、システムはエラーをログに記録し、他のイベントの処理を継続する
5. イベントが見つからない時、システムは結果をログに記録し、正常に完了する

### 要件2

**ユーザーストーリー:**
システム管理者として、重複するイベント登録を防ぎたい。これにより、同じイベントが複数回登録されることを防げる。

#### 受け入れ基準

1. 重複をチェックする時、システムは同じイベントURLを持つ既存レコードをDynamoDBで検索する
2. イベントURLがDynamoDBに既に存在する時、システムはそのイベントの登録をスキップする
3. イベントURLがDynamoDBに存在しない時、システムは登録処理を続行する
4. URLを比較する時、システムはイベントURLフィールドで完全一致文字列マッチングを使用する
5. 重複検出が失敗した時、システムはエラーをログに記録し、問題のあるイベントをスキップする

### 要件3

**ユーザーストーリー:**
システム管理者として、新しい広島イベントが手動登録と同じデータ構造で登録されるようにしたい。これにより、既存のワークフローとシームレスに統合できる。

#### 受け入れ基準

1. 新しいイベントレコードを作成する時、システムは手動登録と同じStudySessionデータ構造を使用する
2. イベントステータスを設定する時、システムは管理者承認のためにステータスを「pending」に設定する
3. イベントIDを生成する時、システムは手動登録と同じID生成方法を使用する
4. タイムスタンプを設定する時、システムはcreatedAtとupdatedAtの両方を現在のISOタイムスタンプに設定する
5. connpass URLが利用可能な時、システムはそれをurlフィールドに保存する（手動登録と同様）

### 要件4

**ユーザーストーリー:**
システム管理者として、自動登録された広島イベントの通知を受け取りたい。これにより、迅速にレビューして承認できる。

#### 受け入れ基準

1. 新しいイベントが正常に登録された時、システムは既存のNotificationServiceと既存の承認処理フローを使用する
2. 通知を送信する時、システムは手動登録と完全に同じ通知形式と承認処理を使用する
3. 通知送信が失敗した時、システムはエラーをログに記録するが、イベント登録は継続する
4. 複数のイベントが登録された時、システムは各イベントに対して個別の通知を送信する
5. 新しいイベントが登録されなかった時、システムは通知を送信しない

### 要件5

**ユーザーストーリー:**
システム管理者として、広島イベント発見機能を既存のバッチ処理スケジュールに統合したい。これにより、追加のインフラなしに自動実行できる。

#### 受け入れ基準

1. 既存のバッチ資料ハンドラーが実行される時、システムは広島イベント発見も実行する
2. 広島イベント発見が失敗した時、システムはエラーをログに記録するが、資料バッチ処理の完了を妨げない
3. 広島イベント検索は1回のAPI呼び出しのみで、既存の資料取得バッチ処理とは独立してレート制限を管理する
4. バッチ処理が完了した時、システムはレスポンスに広島イベント発見結果を含める
5. 手動バッチ実行がトリガーされた時、システムは手動実行に広島イベント発見を含める

### 要件6

**ユーザーストーリー:**
システム管理者として、広島イベント発見プロセスの包括的なログを取得したい。これにより、自動登録システムを監視・トラブルシューティングできる。

#### 受け入れ基準

1. 広島イベント発見を開始する時、システムはタイムスタンプ付きでプロセスの開始をログに記録する
2. 各イベントを処理する時、システムはタイトル、URL、登録決定を含むイベント詳細をログに記録する
3. エラーが発生した時、システムはスタックトレースを含む詳細なエラー情報をログに記録する
4. 発見が完了した時、システムは見つかった総数、新規登録数、スキップした重複数を含む要約統計をログに記録する
5. APIレート制限が発生した時、システムは待機期間とレート制限遵守をログに記録する
